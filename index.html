<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Áúü„ÉªÂõõ‰∫∫Â∞ÜÊ£ã</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --cell:40px;
  --wood:#f4d9a6;
  --wood2:#e2b36d;
  --bg:#d9932a;
  --frame:#c6862c;
  --sel:#ff0;
  --move:#8fd3ff;
}
body{margin:0;padding:10px;background:var(--bg);font-family:sans-serif}
h1{margin:4px 0;font-size:18px}
button{padding:6px 10px;border-radius:6px;border:1px solid #888;background:#fff7e0}

.layout{
  display:grid;
  grid-template-columns:200px auto 200px;
  grid-template-rows:auto auto;
  gap:10px;
}
.board{
  grid-column:2;
  grid-row:1 / span 2;
  display:grid;
  grid-template-columns:repeat(15,var(--cell));
  grid-template-rows:repeat(15,var(--cell));
  gap:2px;
  background:var(--frame);
  padding:6px;
  border-radius:8px;
}
.cell{
  background:var(--wood);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
}
.dark{background:var(--wood2)}
.wall{background:var(--bg);pointer-events:none}
.sel{outline:3px solid var(--sel)}
.move{background:var(--move)!important}

.p0{transform:rotate(180deg)}
.p1{transform:rotate(270deg)}
.p2{transform:rotate(0deg)}
.p3{transform:rotate(90deg)}

.hand{
  background:#fff3d4;
  padding:6px;
  border-radius:6px;
}
.hand h3{margin:0 0 6px;font-size:13px;text-align:center}
.list{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.pc{
  background:#fff;
  border:1px solid #999;
  border-radius:4px;
  padding:4px 6px;
  cursor:pointer;
}

.win{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  z-index:10;
}
</style>
</head>
<body>

<h1>Áúü„ÉªÂõõ‰∫∫Â∞ÜÊ£ã</h1>
<div>
  <span id="turn"></span>
  <button onclick="undo()">ÂæÖ„Å£„Åü</button>
  <button onclick="init()">ÂàùÊúüÂåñ</button>
</div>

<div class="layout">
  <div class="hand" id="hand0"></div>
  <div class="hand" id="hand1"></div>
  <div class="board" id="board"></div>
  <div class="hand" id="hand3"></div>
  <div class="hand" id="hand2"></div>
</div>

<div id="win" class="win" style="display:none"></div>

<script>
const N=15;
const boardEl=document.getElementById('board');
const turnEl=document.getElementById('turn');
const winEl=document.getElementById('win');
const handsEl=[hand0,hand1,hand2,hand3];

let board,hands,alive,turn;
let sel=null, selHand=null, marks=[];
let history=[];

const back=['È¶ô','Ê°Ç','ÈäÄ','Èáë','Áéã','Èáë','ÈäÄ','Ê°Ç','È¶ô'];
const promote={Ê≠©:'„Å®',È¶ô:'Êùè',Ê°Ç:'Âú≠',ÈäÄ:'ÂÖ®',Ëßí:'È¶¨',È£õ:'Èæç'};
const unpromote={„Å®:'Ê≠©',Êùè:'È¶ô',Âú≠:'Ê°Ç',ÂÖ®:'ÈäÄ',È¶¨:'Ëßí',Èæç:'È£õ'};

const zone={
  0:r=>r>=11, 1:c=>c<=3, 2:r=>r<=3, 3:c=>c>=11
};

function inPlay(r,c){
  if(r<3&&c<3) return false;
  if(r<3&&c>=12) return false;
  if(r>=12&&c<3) return false;
  if(r>=12&&c>=12) return false;
  return r>=0&&r<N&&c>=0&&c<N;
}
function dir(o){return[[1,0],[0,-1],[-1,0],[0,1]][o];}

function snapshot(){
  history.push(JSON.stringify({board,hands,alive,turn}));
}

function undo(){
  if(!history.length) return;
  let s=JSON.parse(history.pop());
  board=s.board; hands=s.hands; alive=s.alive; turn=s.turn;
  sel=null; selHand=null; marks=[];
  winEl.style.display='none';
  draw();
}

function init(){
  board=[...Array(N)].map(()=>Array(N).fill(null));
  hands=[[],[],[],[]];
  alive=[true,true,true,true];
  turn=0; sel=null; selHand=null; marks=[]; history=[];
  winEl.style.display='none';
  placeInitial(); draw();
}

function placeInitial(){
  const cols=[3,4,5,6,7,8,9,10,11];
  const rows=[3,4,5,6,7,8,9,10,11];
  for(let i=0;i<9;i++) board[0][cols[i]]={t:back[i],o:0};
  board[1][4]={t:'È£õ',o:0}; board[1][10]={t:'Ëßí',o:0};
  for(let i=0;i<9;i++) board[2][cols[i]]={t:'Ê≠©',o:0};

  for(let i=0;i<9;i++) board[rows[i]][14]={t:back[i],o:1};
  board[4][13]={t:'È£õ',o:1}; board[10][13]={t:'Ëßí',o:1};
  for(let i=0;i<9;i++) board[rows[i]][12]={t:'Ê≠©',o:1};

  for(let i=0;i<9;i++) board[14][cols[8-i]]={t:back[i],o:2};
  board[13][10]={t:'È£õ',o:2}; board[13][4]={t:'Ëßí',o:2};
  for(let i=0;i<9;i++) board[12][cols[8-i]]={t:'Ê≠©',o:2};

  for(let i=0;i<9;i++) board[rows[8-i]][0]={t:back[i],o:3};
  board[10][1]={t:'È£õ',o:3}; board[4][1]={t:'Ëßí',o:3};
  for(let i=0;i<9;i++) board[rows[8-i]][2]={t:'Ê≠©',o:3};
}

function hasPawn(o,c){
  for(let r=0;r<N;r++){
    let p=board[r][c];
    if(p && p.o===o && p.t==='Ê≠©') return true;
  }
  return false;
}

function genMoves(p,r,c){
  let res=[];
  let F=dir(p.o), B=[-F[0],-F[1]], L=[F[1],-F[0]], R=[-F[1],F[0]];
  let FL=[F[0]+L[0],F[1]+L[1]], FR=[F[0]+R[0],F[1]+R[1]];
  let BL=[B[0]+L[0],B[1]+L[1]], BR=[B[0]+R[0],B[1]+R[1]];

  const add=(dr,dc,rep=false)=>{
    let nr=r+dr,nc=c+dc;
    while(inPlay(nr,nc)){
      if(board[nr][nc] && board[nr][nc].o===p.o) break;
      res.push([nr,nc]);
      if(board[nr][nc]||!rep) break;
      nr+=dr; nc+=dc;
    }
  };

  switch(p.t){
    case 'Ê≠©': add(F[0],F[1]); break;
    case 'È¶ô': add(F[0],F[1],true); break;
    case 'Ê°Ç': add(F[0]*2+L[0],F[1]*2+L[1]); add(F[0]*2+R[0],F[1]*2+R[1]); break;
    case 'ÈäÄ': [F,L,R,FL,FR].forEach(v=>add(v[0],v[1])); break;
    case 'Èáë':
    case '„Å®':case 'Êùè':case 'Âú≠':case 'ÂÖ®':
      [F,L,R,B,FL,FR].forEach(v=>add(v[0],v[1])); break;
    case 'È£õ': [F,B,L,R].forEach(v=>add(v[0],v[1],true)); break;
    case 'Ëßí': [FL,FR,BL,BR].forEach(v=>add(v[0],v[1],true)); break;
    case 'Èæç':
      [F,B,L,R].forEach(v=>add(v[0],v[1],true));
      [FL,FR,BL,BR].forEach(v=>add(v[0],v[1])); break;
    case 'È¶¨':
      [FL,FR,BL,BR].forEach(v=>add(v[0],v[1],true));
      [F,B,L,R].forEach(v=>add(v[0],v[1])); break;
  }
  return res;
}

function maybePromote(p,fr,fc,tr,tc){
  if(!promote[p.t]) return p.t;
  if(zone[p.o](fr) || zone[p.o](tr)){
    return confirm('Êàê„Çä„Åæ„Åô„ÅãÔºü') ? promote[p.t] : p.t;
  }
  return p.t;
}

function checkWin(){
  let a=alive.map((v,i)=>v?i:null).filter(v=>v!==null);
  if(a.length===1){
    winEl.textContent=`üéâ P${a[0]+1} „ÅÆÂãù„Å°„ÇÑÔºÅ`;
    winEl.style.display='flex';
  }
}

function clickCell(r,c){
  if(!inPlay(r,c)) return;

  if(selHand){
    if(selHand.t==='Ê≠©' && hasPawn(turn,c)) return;
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      snapshot();
      board[r][c]={t:selHand.t,o:turn};
      hands[turn].splice(selHand.i,1);
      selHand=null; marks=[];
      nextTurn(); draw();
    }
    return;
  }

  if(sel){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      snapshot();
      let p=board[sel.r][sel.c];
      let cap=board[r][c];
      let nt=maybePromote(p,sel.r,sel.c,r,c);
      board[r][c]={t:nt,o:p.o};
      board[sel.r][sel.c]=null;
      if(cap){
        if(cap.t==='Áéã'){ alive[cap.o]=false; checkWin(); }
        else hands[turn].push(unpromote[cap.t]||cap.t);
      }
      sel=null; marks=[];
      nextTurn(); draw();
    }else{ sel=null; marks=[]; draw(); }
    return;
  }

  let p=board[r][c];
  if(p && p.o===turn && alive[p.o]){
    sel={r,c}; marks=genMoves(p,r,c); draw();
  }
}

function clickHand(o,i){
  if(o!==turn || !alive[o]) return;
  selHand={o,i,t:hands[o][i]};
  marks=[];
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    if(inPlay(r,c)&&!board[r][c]) marks.push([r,c]);
  }
  draw();
}

function nextTurn(){
  do{ turn=(turn+1)%4 }while(!alive[turn]);
}

function draw(){
  boardEl.innerHTML='';
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let d=document.createElement('div');
    if(!inPlay(r,c)){ d.className='cell wall'; boardEl.appendChild(d); continue; }
    d.className='cell '+((r+c)%2?'dark':'');
    if(sel&&sel.r===r&&sel.c===c) d.classList.add('sel');
    if(marks.some(m=>m[0]===r&&m[1]===c)) d.classList.add('move');
    if(board[r][c]){
      let s=document.createElement('span');
      s.textContent=board[r][c].t;
      s.className='p'+board[r][c].o;
      d.appendChild(s);
    }
    d.onclick=()=>clickCell(r,c);
    boardEl.appendChild(d);
  }

  turnEl.textContent='ÊâãÁï™ÔºöP'+(turn+1);

  handsEl.forEach((el,o)=>{
    el.innerHTML=alive[o]
      ? `<h3>P${o+1} ÊåÅ„Å°Èßí</h3><div class="list"></div>`
      : `<h3>P${o+1} ËÑ±ËêΩ</h3>`;
    if(!alive[o]) return;
    let list=el.querySelector('.list');
    hands[o].forEach((pc,i)=>{
      let d=document.createElement('div');
      d.className='pc'; d.textContent=pc;
      d.onclick=()=>clickHand(o,i);
      list.appendChild(d);
    });
  });
}

init();
</script>
</body>
</html>
