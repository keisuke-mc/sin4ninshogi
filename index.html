<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>真・四人将棋</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --cell:40px; --wood:#f4d9a6; --wood2:#e2b36d;
  --bg:#d9932a; --frame:#c6862c;
  --sel:#ff0; --move:#8fd3ff;
}
body{margin:0;padding:10px;background:var(--bg);font-family:sans-serif}
.board{
  display:grid;
  grid-template-columns:repeat(15,var(--cell));
  grid-template-rows:repeat(15,var(--cell));
  gap:2px;background:var(--frame);padding:6px;border-radius:8px;
}
.cell{background:var(--wood);display:flex;align-items:center;justify-content:center;cursor:pointer}
.dark{background:var(--wood2)}
.wall{background:var(--bg);pointer-events:none}
.sel{outline:3px solid var(--sel)}
.move{background:var(--move)!important}
.p0{transform:rotate(180deg)}
.p1{transform:rotate(270deg)}
.p2{transform:rotate(0deg)}
.p3{transform:rotate(90deg)}
.hand{background:#fff3d4;padding:6px;border-radius:6px}
.pc{background:#fff;border:1px solid #999;padding:4px;cursor:pointer}
</style>
</head>
<body>

<h3 id="turn"></h3>
<div style="display:grid;grid-template-columns:200px auto 200px;gap:10px">
  <div id="hand0" class="hand"></div>
  <div id="board" class="board"></div>
  <div id="hand1" class="hand"></div>
</div>
<div style="display:grid;grid-template-columns:200px 200px;gap:10px;margin-top:6px">
  <div id="hand3" class="hand"></div>
  <div id="hand2" class="hand"></div>
</div>

<script>
const N=15;
const boardEl=document.getElementById("board");
const turnEl=document.getElementById("turn");
const handsEl=[
  hand0=document.getElementById("hand0"),
  hand1=document.getElementById("hand1"),
  hand2=document.getElementById("hand2"),
  hand3=document.getElementById("hand3")
];

const back=['香','桂','銀','金','王','金','銀','桂','香'];
const unpromote={と:'歩',杏:'香',圭:'桂',全:'銀',馬:'角',龍:'飛'};

let board,hands,alive,turn,sel=null,selHand=null,marks=[];

function dir(o){return[[1,0],[0,-1],[-1,0],[0,1]][o];}
function inPlay(r,c){
  if(r<3&&c<3) return false;
  if(r<3&&c>=12) return false;
  if(r>=12&&c<3) return false;
  if(r>=12&&c>=12) return false;
  return r>=0&&r<N&&c>=0&&c<N;
}

function init(){
  board=[...Array(N)].map(()=>Array(N).fill(null));
  hands=[[],[],[],[]];
  alive=[true,true,true,true];
  turn=0; sel=null; selHand=null; marks=[];
  placeInitial(); draw();
}

function placeInitial(){
  const cols=[3,4,5,6,7,8,9,10,11];
  const rows=[3,4,5,6,7,8,9,10,11];
  for(let i=0;i<9;i++) board[0][cols[i]]={t:back[i],o:0};
  for(let i=0;i<9;i++) board[14][cols[8-i]]={t:back[i],o:2};
  for(let i=0;i<9;i++) board[rows[i]][14]={t:back[i],o:1};
  for(let i=0;i<9;i++) board[rows[8-i]][0]={t:back[i],o:3};
}

function genMoves(p,r,c){
  let res=[];
  let F=dir(p.o),B=[-F[0],-F[1]],L=[F[1],-F[0]],R=[-F[1],F[0]];
  const add=(dr,dc,rep=false)=>{
    let nr=r+dr,nc=c+dc;
    while(inPlay(nr,nc)){
      if(board[nr][nc]&&board[nr][nc].o===p.o) break;
      res.push([nr,nc]);
      if(board[nr][nc]||!rep) break;
      nr+=dr; nc+=dc;
    }
  };
  if(p.t==='王') [F,B,L,R].forEach(v=>add(v[0],v[1]));
  return res;
}

function eliminate(o){ alive[o]=false; hands[o]=[]; }

function nextTurn(){
  do{ turn=(turn+1)%4 }while(!alive[turn]);
}

function clickCell(r,c){
  if(!inPlay(r,c)) return;

  if(selHand){
    if(!board[r][c]){
      board[r][c]={t:selHand.t,o:turn};
      hands[turn].splice(selHand.i,1);
      selHand=null; nextTurn(); draw();
    }
    return;
  }

  if(sel){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      let cap=board[r][c];
      board[r][c]=board[sel.r][sel.c];
      board[sel.r][sel.c]=null;
      if(cap){
        if(cap.t==='王') eliminate(cap.o);
        else hands[turn].push(unpromote[cap.t]||cap.t);
      }
      sel=null; marks=[]; nextTurn(); draw();
    }
    return;
  }

  let p=board[r][c];
  if(p&&p.o===turn){
    sel={r,c}; marks=genMoves(p,r,c); draw();
  }
}

function clickHand(o,i){
  if(o!==turn||!alive[o]) return;
  selHand={o,i,t:hands[o][i]};
  marks=[];
  for(let r=0;r<N;r++)for(let c=0;c<N;c++)
    if(inPlay(r,c)&&!board[r][c]) marks.push([r,c]);
  draw();
}

function draw(){
  boardEl.innerHTML='';
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let d=document.createElement("div");
    if(!inPlay(r,c)){d.className="cell wall";boardEl.appendChild(d);continue;}
    d.className="cell "+((r+c)%2?"dark":"");
    if(sel&&sel.r===r&&sel.c===c)d.classList.add("sel");
    if(marks.some(m=>m[0]===r&&m[1]===c))d.classList.add("move");
    if(board[r][c]){
      let s=document.createElement("span");
      s.textContent=board[r][c].t;
      s.className="p"+board[r][c].o;
      d.appendChild(s);
    }
    d.onclick=()=>clickCell(r,c);
    boardEl.appendChild(d);
  }

  turnEl.textContent="手番：P"+(turn+1);

  handsEl.forEach((el,o)=>{
    if(!alive[o]){ el.innerHTML="P"+(o+1)+" 脱落"; return; }
    el.innerHTML="P"+(o+1)+"<br>";
    hands[o].forEach((p,i)=>{
      let d=document.createElement("div");
      d.className="pc"; d.textContent=p;
      d.onclick=()=>clickHand(o,i);
      el.appendChild(d);
    });
  });
}

init();
</script>
</body>
</html>
