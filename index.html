<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>çœŸãƒ»å››äººå°†æ£‹</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --cell:40px;
  --wood:#f4d9a6;
  --wood2:#e2b36d;
  --bg:#d9932a;
  --frame:#c6862c;
  --sel:#ff0;
  --move:#8fd3ff;
  --turnGlow:#4aa3ff;
}
body{margin:0;padding:10px;background:var(--bg);font-family:sans-serif}
h1{margin:4px 0;font-size:18px}
button{padding:6px 10px;border-radius:6px;border:1px solid #888;background:#fff7e0}

#status{margin-left:10px;font-weight:bold}

.layout{
  display:grid;
  grid-template-columns:200px auto 200px;
  grid-template-rows:auto auto;
  gap:10px;
}

.boardWrap{
  grid-column:2;
  grid-row:1 / span 2;
  padding:6px;
  border-radius:10px;
}
.boardWrap.turn0{box-shadow:0 -8px 20px var(--turnGlow)}
.boardWrap.turn1{box-shadow:8px 0 20px var(--turnGlow)}
.boardWrap.turn2{box-shadow:0 8px 20px var(--turnGlow)}
.boardWrap.turn3{box-shadow:-8px 0 20px var(--turnGlow)}

.board{
  display:grid;
  grid-template-columns:repeat(15,var(--cell));
  grid-template-rows:repeat(15,var(--cell));
  gap:2px;
  background:var(--frame);
  padding:6px;
  border-radius:8px;
}

.cell{
  background:var(--wood);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
}
.dark{background:var(--wood2)}
.wall{background:var(--bg);pointer-events:none}
.sel{outline:3px solid var(--sel)}
.move{background:var(--move)!important}

.p0{transform:rotate(180deg)}
.p1{transform:rotate(270deg)}
.p2{transform:rotate(0deg)}
.p3{transform:rotate(90deg)}

.hand{
  background:#fff3d4;
  padding:6px;
  border-radius:6px;
}
.hand h3{margin:0 0 6px;font-size:13px;text-align:center}
.list{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.pc{
  background:#fff;
  border:1px solid #999;
  border-radius:4px;
  padding:4px 6px;
  cursor:pointer;
}

.win{
  font-size:20px;
  color:#0044ff;
  animation:blink 1s infinite;
}
@keyframes blink{
  0%{opacity:1}
  50%{opacity:0.3}
  100%{opacity:1}
}
</style>
</head>

<body>

<h1>çœŸãƒ»å››äººå°†æ£‹</h1>
<div>
  <span id="turn"></span>
  <span id="status"></span>
  <button onclick="undo()">å¾…ã£ãŸ</button>
  <button onclick="init()">åˆæœŸåŒ–</button>
</div>

<div class="layout">
  <div class="hand" id="hand0"></div>
  <div class="hand" id="hand1"></div>

  <div class="boardWrap" id="wrap">
    <div class="board" id="board"></div>
  </div>

  <div class="hand" id="hand3"></div>
  <div class="hand" id="hand2"></div>
</div>

<script>
/* ================= åŸºæœ¬ ================= */
const N=15;
const boardEl=document.getElementById('board');
const wrap=document.getElementById('wrap');
const turnEl=document.getElementById('turn');
const statusEl=document.getElementById('status');
const handsEl=[hand0,hand1,hand2,hand3];

let board,hands,alive,turn;
let sel=null, marks=[];
let history=[];

const promote={æ­©:'ã¨',é¦™:'æ',æ¡‚:'åœ­',éŠ€:'å…¨',è§’:'é¦¬',é£›:'é¾'};
const unpromote={ã¨:'æ­©',æ:'é¦™',åœ­:'æ¡‚',å…¨:'éŠ€',é¦¬:'è§’',é¾:'é£›'};

/* ================= ç›¤åˆ¤å®š ================= */
function inPlay(r,c){
  if(r<3&&c<3) return false;
  if(r<3&&c>=12) return false;
  if(r>=12&&c<3) return false;
  if(r>=12&&c>=12) return false;
  return r>=0&&r<N&&c>=0&&c<N;
}
function dir(o){return[[1,0],[0,-1],[-1,0],[0,1]][o];}

/* ================= åˆæœŸé…ç½® ================= */
function init(){
  board=[...Array(N)].map(()=>Array(N).fill(null));
  hands=[[],[],[],[]];
  alive=[true,true,true,true];
  turn=0; sel=null; marks=[]; history=[];
  placeInitial();
  draw();
}
function placeInitial(){
  const back=['é¦™','æ¡‚','éŠ€','é‡‘','ç‹','é‡‘','éŠ€','æ¡‚','é¦™'];
  const cols=[3,4,5,6,7,8,9,10,11];
  for(let i=0;i<9;i++) board[0][cols[i]]={t:back[i],o:0};
  board[1][4]={t:'é£›',o:0}; board[1][10]={t:'è§’',o:0};
  for(let i=0;i<9;i++) board[2][cols[i]]={t:'æ­©',o:0};

  const rows=[3,4,5,6,7,8,9,10,11];
  for(let i=0;i<9;i++) board[rows[i]][14]={t:back[i],o:1};
  board[4][13]={t:'é£›',o:1}; board[10][13]={t:'è§’',o:1};
  for(let i=0;i<9;i++) board[rows[i]][12]={t:'æ­©',o:1};

  for(let i=0;i<9;i++) board[14][cols[8-i]]={t:back[i],o:2};
  board[13][10]={t:'é£›',o:2}; board[13][4]={t:'è§’',o:2};
  for(let i=0;i<9;i++) board[12][cols[8-i]]={t:'æ­©',o:2};

  for(let i=0;i<9;i++) board[rows[8-i]][0]={t:back[i],o:3};
  board[10][1]={t:'é£›',o:3}; board[4][1]={t:'è§’',o:3};
  for(let i=0;i<9;i++) board[rows[8-i]][2]={t:'æ­©',o:3};
}

/* ================= å‹•ãç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆï¼‰ ================= */
function genMoves(p,r,c){
  let res=[], d=dir(p.o);
  const add=(dr,dc,rep=false)=>{
    let nr=r+dr,nc=c+dc;
    while(inPlay(nr,nc)){
      if(board[nr][nc]&&board[nr][nc].o===p.o) break;
      res.push([nr,nc]);
      if(board[nr][nc]||!rep) break;
      nr+=dr; nc+=dc;
    }
  };
  switch(p.t){
  
  case 'æ­©':
    add(F[0],F[1]);
    break;
  
  case 'é¦™':
    add(F[0],F[1],true);
    break;
  
  case 'æ¡‚':
    add(F[0]*2 + L[0], F[1]*2 + L[1]);
    add(F[0]*2 + R[0], F[1]*2 + R[1]);
    break;
  
  case 'éŠ€':
    [
      F,
      L,
      R,
      [F[0]+L[0],F[1]+L[1]],
      [F[0]+R[0],F[1]+R[1]]
    ].forEach(v=>add(v[0],v[1]));
    break;
  
  case 'é‡‘':
  case 'ã¨': case 'æ': case 'åœ­': case 'å…¨':
    [
      F,
      L,
      R,
      B,
      [F[0]+L[0],F[1]+L[1]],
      [F[0]+R[0],F[1]+R[1]]
    ].forEach(v=>add(v[0],v[1]));
    break;
    case 'ç‹':
      for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++)
        if(dr||dc) add(dr,dc);
  }
  return res;
}

/* ================= ç‹æ‰‹ãƒ»è©°ã¿ ================= */
function kingPos(o){
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let p=board[r][c];
    if(p&&p.o===o&&p.t==='ç‹') return [r,c];
  }
  return null;
}
function inCheck(o){
  let k=kingPos(o);
  if(!k) return false;
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let p=board[r][c];
    if(p&&p.o!==o){
      if(genMoves(p,r,c).some(m=>m[0]===k[0]&&m[1]===k[1])) return true;
    }
  }
  return false;
}
function hasEscape(o){
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let p=board[r][c];
    if(p&&p.o===o){
      for(let [nr,nc] of genMoves(p,r,c)){
        let save=board[nr][nc];
        board[nr][nc]=p; board[r][c]=null;
        let ok=!inCheck(o);
        board[r][c]=p; board[nr][nc]=save;
        if(ok) return true;
      }
    }
  }
  return false;
}
function checkMate(o){
  return inCheck(o)&&!hasEscape(o);
}

/* ================= æ‰‹ç•ª ================= */
function nextTurn(){
  do{turn=(turn+1)%4}while(!alive[turn]);
}

/* ================= ã‚¯ãƒªãƒƒã‚¯ ================= */
function clickCell(r,c){
  if(!inPlay(r,c)) return;
  if(sel){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      history.push(JSON.stringify({board,hands,alive,turn}));
      let p=board[sel.r][sel.c];
      let cap=board[r][c];
      if(cap && cap.t==='ç‹' && checkMate(cap.o)) return;
      board[r][c]=p; board[sel.r][sel.c]=null;
      if(cap && cap.t!=='ç‹') hands[turn].push(unpromote[cap.t]||cap.t);
      sel=null; marks=[];
      if(checkMate(turn)){
        alive[turn]=false;
      }
      nextTurn(); draw();
    }else{sel=null;marks=[];draw();}
    return;
  }
  let p=board[r][c];
  if(p&&p.o===turn){
    sel={r,c};
    marks=legalMoves(p,r,c);
    draw();
  }
}

/* ================= æç”» ================= */
function draw(){
  boardEl.innerHTML='';
  wrap.className='boardWrap turn'+turn;
  let aliveCnt=alive.filter(x=>x).length;

  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let d=document.createElement('div');
    if(!inPlay(r,c)){d.className='cell wall';boardEl.appendChild(d);continue;}
    d.className='cell '+((r+c)%2?'dark':'');
    if(sel&&sel.r===r&&sel.c===c)d.classList.add('sel');
    if(marks.some(m=>m[0]===r&&m[1]===c))d.classList.add('move');
    if(board[r][c]){
      let s=document.createElement('span');
      s.textContent=board[r][c].t;
      s.className='p'+board[r][c].o;
      d.appendChild(s);
    }
    d.onclick=()=>clickCell(r,c);
    boardEl.appendChild(d);
  }

  turnEl.textContent='æ‰‹ç•ªï¼šP'+(turn+1);
  statusEl.textContent=inCheck(turn)?' ç‹æ‰‹ï¼':'';

  if(aliveCnt===1){
    let w=alive.indexOf(true);
    statusEl.innerHTML='<span class="win">ğŸ‰ P'+(w+1)+' ã®å‹åˆ©ï¼ ğŸ‰</span>';
  }

  handsEl.forEach((el,o)=>{
    el.innerHTML='<h3>P'+(o+1)+' æŒã¡é§’</h3><div class="list"></div>';
    let list=el.querySelector('.list');
    hands[o].forEach(pc=>{
      let d=document.createElement('div');
      d.className='pc'; d.textContent=pc;
      list.appendChild(d);
    });
  });
}

/* ================= Undo ================= */
function undo(){
  if(!history.length) return;
  let h=JSON.parse(history.pop());
  board=h.board; hands=h.hands; alive=h.alive; turn=h.turn;
  sel=null; marks=[];
  draw();
}

function legalMoves(p,r,c){
  let res=[];
  for(let [nr,nc] of genMoves(p,r,c)){
    let save=board[nr][nc];
    board[nr][nc]=p; board[r][c]=null;
    let ok=!inCheck(p.o);
    board[r][c]=p; board[nr][nc]=save;
    if(ok) res.push([nr,nc]);
  }
  return res;
}
init();
</script>
</body>
</html>
