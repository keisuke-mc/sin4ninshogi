<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>四人将棋 15x15 完全版</title>
<style>
body{
  margin:0;
  background:#2b2b2b;
  color:#eee;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
#wrap{
  display:grid;
  grid-template-columns:220px 1fr 220px;
  gap:12px;
  align-items:center;
}
.side{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-height:600px;
}
.holder{
  border:1px solid #555;
  padding:6px;
  min-height:120px;
}
.holder h3{
  margin:0 0 4px;
  font-size:14px;
  text-align:center;
}
.holder .piece{
  display:inline-block;
  margin:2px;
}
#board{
  display:grid;
  grid-template-columns:repeat(15,36px);
  grid-template-rows:repeat(15,36px);
  background:#cfa96a;
  padding:6px;
}
.cell{
  width:36px;
  height:36px;
  border:1px solid #555;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  cursor:pointer;
  user-select:none;
}
.disabled{
  background:#444;
  cursor:default;
}
.piece{
  background:#f5deb3;
  border:1px solid #333;
  width:30px;
  height:30px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.p1{color:#000;}
.p2{color:#0033cc;}
.p3{color:#009933;}
.p4{color:#cc0000;}

.highlight{
  outline:3px solid red;
}
.selected{
  outline:3px solid blue;
}
#controls{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
}
</style>
</head>
<body>

<div id="wrap">
  <div class="side">
    <div class="holder" id="hold1"><h3>P1</h3></div>
    <div class="holder" id="hold4"><h3>P4</h3></div>
  </div>

  <div id="board"></div>

  <div class="side">
    <div class="holder" id="hold2"><h3>P2</h3></div>
    <div class="holder" id="hold3"><h3>P3</h3></div>
  </div>
</div>

<div id="controls">
  <button onclick="undo()">待った</button>
  <span id="turn"></span>
</div>

<script>
/* ===== 基本設定 ===== */
const SIZE = 15;
const players = ["p1","p2","p3","p4"];
let turn = 0;
let history=[];

const board = document.getElementById("board");
const turnSpan=document.getElementById("turn");

/* ===== 盤生成 ===== */
let cells=[];
let pieces={}; // key "x,y"

for(let y=0;y<SIZE;y++){
  for(let x=0;x<SIZE;x++){
    const c=document.createElement("div");
    c.className="cell";
    // 四隅3x3無効
    if((x<3&&y<3)||(x>11&&y<3)||(x<3&&y>11)||(x>11&&y>11)){
      c.classList.add("disabled");
    }
    c.dataset.x=x;
    c.dataset.y=y;
    c.onclick=()=>clickCell(x,y);
    board.appendChild(c);
    cells.push(c);
  }
}

/* ===== 駒定義 ===== */
function makePiece(type,owner,promoted=false){
  return {type,owner,promoted};
}

/* ===== 初期配置（歩＋香車追加）===== */
function place(x,y,p){ pieces[`${x},${y}`]=p; }

for(let i=3;i<=11;i++){
  place(i,1,makePiece("歩","p3"));
  place(i,13,makePiece("歩","p1"));
  place(1,i,makePiece("歩","p2"));
  place(13,i,makePiece("歩","p4"));
}
place(7,14,makePiece("王","p1"));
place(14,7,makePiece("王","p2"));
place(7,0,makePiece("王","p3"));
place(0,7,makePiece("王","p4"));

place(7,12,makePiece("香","p1"));
place(12,7,makePiece("香","p2"));
place(7,2,makePiece("香","p3"));
place(2,7,makePiece("香","p4"));

/* ===== 向き ===== */
const dir={
 p1:[0,-1],
 p2:[-1,0],
 p3:[0,1],
 p4:[1,0]
};

/* ===== 駒の動き（修正版）===== */
function moves(piece,x,y){
 let res=[];
 const [dx,dy]=dir[piece.owner];

 function step(vx,vy){
   const nx=x+vx, ny=y+vy;
   if(nx<0||ny<0||nx>=SIZE||ny>=SIZE) return;
   if(document.querySelector(`.cell[data-x="${nx}"][data-y="${ny}"]`).classList.contains("disabled")) return;
   if(!pieces[`${nx},${ny}`]||pieces[`${nx},${ny}`].owner!==piece.owner)
     res.push([nx,ny]);
 }

 function slide(vx,vy){
   let nx=x+vx, ny=y+vy;
   while(nx>=0&&ny>=0&&nx<SIZE&&ny<SIZE){
     if(document.querySelector(`.cell[data-x="${nx}"][data-y="${ny}"]`).classList.contains("disabled")) break;
     if(pieces[`${nx},${ny}`]){
       if(pieces[`${nx},${ny}`].owner!==piece.owner) res.push([nx,ny]);
       break;
     }
     res.push([nx,ny]);
     nx+=vx; ny+=vy;
   }
 }

 const t=piece.type;
 const g = piece.promoted || ["金"].includes(t);

 if(t==="歩"&&!piece.promoted){
   step(dx,dy);
 }
 else if(t==="香"&&!piece.promoted){
   slide(dx,dy);
 }
 else if(t==="桂"&&!piece.promoted){
   step(dx*2+dy,dy*2-dx);
   step(dx*2-dy,dy*2+dx);
 }
 else if(t==="銀"&&!piece.promoted){
   step(dx,dy);
   step(dx+dy,dy-dx);
   step(dx-dy,dy+dx);
   step(-dx+dy,-dy-dx);
   step(-dx-dy,-dy+dx);
 }
 else if(g){
   step(dx,dy);
   step(dx+dy,dy-dx);
   step(dx-dy,dy+dx);
   step(dy,-dx);
   step(-dy,dx);
   step(-dx,-dy);
 }
 else if(t==="王"){
   for(let vx=-1;vx<=1;vx++)
    for(let vy=-1;vy<=1;vy++)
     if(vx||vy) step(vx,vy);
 }
 return res;
}

/* ===== 描画 ===== */
function render(){
 cells.forEach(c=>{
   c.innerHTML="";
   c.classList.remove("highlight","selected");
 });
 for(const k in pieces){
   const [x,y]=k.split(",").map(Number);
   const c=document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
   const p=document.createElement("div");
   p.className="piece "+pieces[k].owner;
   p.textContent=(pieces[k].promoted?"成":"")+pieces[k].type;
   c.appendChild(p);
 }
 turnSpan.textContent="手番："+players[turn];
}
render();

/* ===== 操作 ===== */
let selected=null;
let legal=[];

function clickCell(x,y){
 const key=`${x},${y}`;
 if(selected){
   if(legal.some(m=>m[0]==x&&m[1]==y)){
     history.push(JSON.stringify(pieces));
     move(selected[0],selected[1],x,y);
     selected=null; legal=[];
     turn=(turn+1)%4;
     render(); return;
   }else{
     selected=null; legal=[]; render(); return;
   }
 }
 if(pieces[key]&&pieces[key].owner===players[turn]){
   selected=[x,y];
   legal=moves(pieces[key],x,y);
   render();
   document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`).classList.add("selected");
   legal.forEach(m=>{
     document.querySelector(`.cell[data-x="${m[0]}"][data-y="${m[1]}"]`).classList.add("highlight");
   });
 }
}

function move(x1,y1,x2,y2){
 const p=pieces[`${x1},${y1}`];
 delete pieces[`${x1},${y1}`];
 if(pieces[`${x2},${y2}`]){ /* 駒取り（持ち駒省略簡略） */}
 pieces[`${x2},${y2}`]=p;
 // 成り判定（選択）
 if(canPromote(p,x2,y2)){
   if(confirm("成りますか？")) p.promoted=true;
 }
}

function canPromote(p,x,y){
 if(p.promoted||["王","金"].includes(p.type))return false;
 const enemy = {
  p1:"p3",p3:"p1",p2:"p4",p4:"p2"
 }[p.owner];
 if(enemy==="p3"&&y<=2)return true;
 if(enemy==="p1"&&y>=12)return true;
 if(enemy==="p2"&&x<=2)return true;
 if(enemy==="p4"&&x>=12)return true;
 return false;
}

function undo(){
 if(history.length){
   pieces=JSON.parse(history.pop());
   turn=(turn+3)%4;
   render();
 }
}
</script>
</body>
</html>
