<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>真・四人将棋</title>
<link rel="icon" href="favicon.ico" type="image/ico">
<style>
body{
  background:#eee;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
}
#wrap{
  display:grid;
  grid-template-columns:200px auto 200px;
  gap:10px;
  margin-top:20px;
}
.hand{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:4px;
  align-content:start;
}
.hand div{
  background:#ddd;
  border:1px solid #999;
  text-align:center;
  cursor:pointer;
}
table{
  border-collapse:collapse;
}
td{
  width:36px;height:36px;
  text-align:center;
  border:1px solid #444;
  font-size:20px;
  cursor:pointer;
  user-select:none;
}
td.block{background:#333;cursor:default;}
td.mark{background:#9f9;}
td.sel{background:#ff9;}
.dead{opacity:0.3;}
</style>
</head>
<body>

<div id="wrap">
  <div id="hand0" class="hand"></div>
  <table id="board"></table>
  <div id="hand1" class="hand"></div>

  <div id="hand3" class="hand"></div>
  <div></div>
  <div id="hand2" class="hand"></div>
</div>

<script>
const SIZE=15;
const BLOCK=3;
const players=[0,1,2,3]; // 上右下左
let turn=0;
let dead=[false,false,false,false];
let sel=null,marks=[];
let board=[];
let hands=[[],[],[],[]];

const promote={P:'+P',L:'+L',N:'+N',S:'+S',B:'+B',R:'+R'};
const unpromote={'+P':'P','+L':'L','+N':'N','+S':'S','+B':'B','+R':'R'};

const dirs={
  P:[[1,0]],
  L:[[1,0,true]],
  N:[[2,-1],[2,1]],
  S:[[1,-1],[1,0],[1,1],[-1,-1],[-1,1]],
  G:[[1,-1],[1,0],[1,1],[0,-1],[0,1],[-1,0]],
  K:[[1,-1],[1,0],[1,1],[0,-1],[0,1],[-1,-1],[-1,0],[-1,1]],
  B:[[1,1,true],[1,-1,true],[-1,1,true],[-1,-1,true]],
  R:[[1,0,true],[-1,0,true],[0,1,true],[0,-1,true]],
  '+P':[[1,-1],[1,0],[1,1],[0,-1],[0,1],[-1,0]],
  '+L':[[1,-1],[1,0],[1,1],[0,-1],[0,1],[-1,0]],
  '+N':[[1,-1],[1,0],[1,1],[0,-1],[0,1],[-1,0]],
  '+S':[[1,-1],[1,0],[1,1],[0,-1],[0,1],[-1,0]],
  '+B':[[1,1,true],[1,-1,true],[-1,1,true],[-1,-1,true],[1,0],[-1,0],[0,1],[0,-1]],
  '+R':[[1,0,true],[-1,0,true],[0,1,true],[0,-1,true],[1,1],[1,-1],[-1,1],[-1,-1]]
};

function init(){
  for(let r=0;r<SIZE;r++){
    board[r]=[];
    for(let c=0;c<SIZE;c++){
      if((r<BLOCK||r>=SIZE-BLOCK)&&(c<BLOCK||c>=SIZE-BLOCK)){
        board[r][c]='X';
      }else board[r][c]=null;
    }
  }
  place(0,3,7,'K'); place(0,4,7,'P'); place(0,5,7,'L');
  place(14,11,7,'K'); place(14,10,7,'P'); place(14,9,7,'L');
  place(7,14,11,'K'); place(7,14,10,'P'); place(7,14,9,'L');
  place(7,0,3,'K'); place(7,0,4,'P'); place(7,0,5,'L');
  draw();
}

function place(r,c,o,t){ board[r][c]={o,t}; }

function draw(){
  const tb=document.getElementById('board');
  tb.innerHTML='';
  for(let r=0;r<SIZE;r++){
    const tr=document.createElement('tr');
    for(let c=0;c<SIZE;c++){
      const td=document.createElement('td');
      if(board[r][c]==='X'){td.className='block';}
      else{
        const p=board[r][c];
        if(p){
          td.textContent=p.t;
          if(dead[p.o]) td.classList.add('dead');
        }
        if(sel&&sel.r===r&&sel.c===c) td.classList.add('sel');
        if(marks.some(m=>m.r===r&&m.c===c)) td.classList.add('mark');
        td.onclick=()=>click(r,c);
      }
      tr.appendChild(td);
    }
    tb.appendChild(tr);
  }
  for(let i=0;i<4;i++){
    const h=document.getElementById('hand'+i);
    h.innerHTML='';
    hands[i].forEach((t,idx)=>{
      const d=document.createElement('div');
      d.textContent=t;
      d.onclick=()=>{ if(turn===i) sel={hand:i,idx,t}; };
      h.appendChild(d);
    });
  }
}

function click(r,c){
  if(dead[turn]){nextTurn();return;}
  if(sel&&sel.hand!=null){
    if(board[r][c]==null){
      board[r][c]={o:turn,t:sel.t};
      hands[turn].splice(sel.idx,1);
      sel=null;marks=[];
      endTurn();
    }
    return;
  }
  const p=board[r][c];
  if(p&&p.o===turn){
    sel={r,c};
    marks=getMoves(r,c,p);
  }else if(sel){
    if(marks.some(m=>m.r===r&&m.c===c)){
      move(r,c);
    }
  }
  draw();
}

function move(r,c){
  const m=board[sel.r][sel.c];
  const cap=board[r][c];
  board[sel.r][sel.c]=null;
  board[r][c]=m;
  if(cap){
    hands[turn].push(unpromote[cap.t]||cap.t);
  }
  if(promote[m.t] && enemyZone(m.o,r)){
    if(confirm('成りますか？')) m.t=promote[m.t];
  }
  sel=null;marks=[];
  endTurn();
}

function enemyZone(o,r){
  if(o===0) return r>10;
  if(o===2) return r<4;
  if(o===1) return r<4;
  if(o===3) return r>10;
}

function getMoves(r,c,p){
  let res=[];
  dirs[p.t].forEach(d=>{
    let dr=d[0],dc=d[1],slide=d[2];
    let rr=r,cc=c;
    while(true){
      rr+=dr;cc+=dc;
      if(rr<0||cc<0||rr>=SIZE||cc>=SIZE)break;
      if(board[rr][cc]==='X')break;
      if(board[rr][cc]){
        if(board[rr][cc].o!==p.o) res.push({r:rr,c:cc});
        break;
      }
      res.push({r:rr,c:cc});
      if(!slide)break;
    }
  });
  return res;
}

function endTurn(){
  checkMate();
  nextTurn();
}

function nextTurn(){
  do{turn=(turn+1)%4;}while(dead[turn]);
  draw();
}

function checkMate(){
  players.forEach(p=>{
    if(dead[p])return;
    if(!hasKing(p)){
      dead[p]=true;
      removePieces(p);
    }
  });
}

function hasKing(p){
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++)
      if(board[r][c]&&board[r][c].o===p&&board[r][c].t==='K') return true;
  return false;
}

function removePieces(p){
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++)
      if(board[r][c]&&board[r][c].o===p) board[r][c]=null;
}

init();
</script>
</body>
</html>
