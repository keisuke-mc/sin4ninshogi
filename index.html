<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>四人将棋 完全版</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:sans-serif;background:#d9932a;margin:0;padding:10px}
h1{font-size:18px;margin:6px 0}
.board{display:grid;grid-template-columns:repeat(13,40px);grid-template-rows:repeat(13,40px);gap:2px;background:#c6862c;padding:6px}
.cell{background:#f4d9a6;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;user-select:none}
.dark{background:#e3b56f}
.sel{outline:3px solid #ff0}
.p0{transform:rotate(180deg)}
.p1{transform:rotate(270deg)}
.p2{transform:rotate(0deg)}
.p3{transform:rotate(90deg)}
.hand{margin:4px 0;background:#fff3d4;padding:4px}
button{margin:4px;padding:4px 8px}
.dead{opacity:.25}
</style>
</head>
<body>

<h1>四人将棋（通常将棋ルール準拠）</h1>
<div id="turn"></div>
<button onclick="undo()">待った</button>
<button onclick="init()">初期化</button>

<div class="board" id="board"></div>

<div id="hands"></div>

<script>
const N=13;
const players=4;
let board,turn=0,sel=null,selHand=null,history=[];
let alive=[true,true,true,true];
let hands=[[],[],[],[]];

const back=['香','桂','銀','金','王','金','銀','桂','香'];
const promote={歩:'と',香:'杏',桂:'圭',銀:'全',角:'馬',飛:'龍'};
const unpromote={と:'歩',杏:'香',圭:'桂',全:'銀',馬:'角',龍:'飛'};

function emptyBoard(){
  board=[...Array(N)].map(()=>Array(N).fill(null));
}

function place(){
  let c=[2,3,4,5,6,7,8,9,10];
  for(let i=0;i<9;i++) board[0][c[i]]={t:back[i],o:0};
  board[1][3]={t:'飛',o:0}; board[1][9]={t:'角',o:0};
  for(let i=0;i<9;i++) board[2][c[i]]={t:'歩',o:0};

  let r=[2,3,4,5,6,7,8,9,10];
  for(let i=0;i<9;i++) board[r[i]][12]={t:back[i],o:1};
  board[3][11]={t:'飛',o:1}; board[9][11]={t:'角',o:1};
  for(let i=0;i<9;i++) board[r[i]][10]={t:'歩',o:1};

  for(let i=0;i<9;i++) board[12][c[8-i]]={t:back[i],o:2};
  board[11][9]={t:'飛',o:2}; board[11][3]={t:'角',o:2};
  for(let i=0;i<9;i++) board[10][c[8-i]]={t:'歩',o:2};

  for(let i=0;i<9;i++) board[r[8-i]][0]={t:back[i],o:3};
  board[9][1]={t:'飛',o:3}; board[3][1]={t:'角',o:3};
  for(let i=0;i<9;i++) board[r[8-i]][2]={t:'歩',o:3};
}

function init(){
  emptyBoard();
  place();
  turn=0; sel=null; selHand=null;
  alive=[true,true,true,true];
  hands=[[],[],[],[]];
  history=[];
  draw();
}

function inBoard(r,c){return r>=0&&r<N&&c>=0&&c<N}

function dir(o){
  return [[1,0],[0,-1],[-1,0],[0,1]][o];
}

function moves(p,r,c){
  let res=[];
  let d=dir(p.o);
  let T=p.t;
  function add(dr,dc,rep=false){
    let nr=r+dr,nc=c+dc;
    while(inBoard(nr,nc)){
      if(board[nr][nc]&&board[nr][nc].o==p.o)break;
      res.push([nr,nc]);
      if(board[nr][nc])break;
      if(!rep)break;
      nr+=dr; nc+=dc;
    }
  }
  if(T=='歩') add(d[0],d[1]);
  else if(T=='香') add(d[0],d[1],true);
  else if(T=='桂') add(d[0]*2+d[1],d[1]*2-d[0]);
  else if(T=='銀'){
    [[d[0],d[1]],[d[1],-d[0]],[-d[1],d[0]],[-d[0]+d[1],-d[1]-d[0]],[-d[0]-d[1],-d[1]+d[0]]].forEach(x=>add(x[0],x[1]));
  }
  else if(T=='金'||['と','杏','圭','全'].includes(T)){
    [[d[0],d[1]],[d[1],-d[0]],[-d[1],d[0]],[0,0],[d[0]-d[1],d[1]+d[0]],[-d[0]+d[1],-d[1]-d[0]]].forEach(x=>{if(x[0]||x[1])add(x[0],x[1])});
  }
  else if(T=='角'||T=='馬'){
    [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(x=>add(x[0],x[1],true));
    if(T=='馬') [[1,0],[-1,0],[0,1],[0,-1]].forEach(x=>add(x[0],x[1]));
  }
  else if(T=='飛'||T=='龍'){
    [[1,0],[-1,0],[0,1],[0,-1]].forEach(x=>add(x[0],x[1],true));
    if(T=='龍') [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(x=>add(x[0],x[1]));
  }
  else if(T=='王'){
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++)if(dr||dc)add(dr,dc);
  }
  return res;
}

function kingPos(o){
  for(let r=0;r<N;r++)for(let c=0;c<N;c++)
    if(board[r][c]&&board[r][c].t=='王'&&board[r][c].o==o)return[r,c];
  return null;
}

function check(o){
  let k=kingPos(o);
  if(!k)return false;
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let p=board[r][c];
    if(p&&p.o!=o&&alive[p.o]){
      if(moves(p,r,c).some(m=>m[0]==k[0]&&m[1]==k[1]))return true;
    }
  }
  return false;
}

function checkmate(o){
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let p=board[r][c];
    if(p&&p.o==o){
      for(let [nr,nc] of moves(p,r,c)){
        let cap=board[nr][nc];
        board[nr][nc]=p; board[r][c]=null;
        if(!check(o)){board[r][c]=p; board[nr][nc]=cap; return false;}
        board[r][c]=p; board[nr][nc]=cap;
      }
    }
  }
  return true;
}

function next(){
  do{turn=(turn+1)%4}while(!alive[turn]);
}

function clickCell(r,c){
  let p=board[r][c];
  if(sel){
    let s=sel;
    if(moves(board[s.r][s.c],s.r,s.c).some(m=>m[0]==r&&m[1]==c)){
      let cap=board[r][c];
      board[r][c]=board[s.r][s.c];
      board[s.r][s.c]=null;
      if(check(turn)){board[s.r][s.c]=board[r][c]; board[r][c]=cap; return;}
      history.push(JSON.stringify({board,hands,alive,turn}));
      if(cap) hands[turn].push(unpromote[cap.t]||cap.t);
      if(checkmate((turn+1)%4)){alive[(turn+1)%4]=false}
      next(); sel=null; draw(); return;
    }
  }
  if(p&&p.o==turn){sel={r,c}; draw()}
}

function draw(){
  let b=document.getElementById("board"); b.innerHTML="";
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let d=document.createElement("div");
    d.className="cell "+((r+c)%2?"dark":"");
    if(sel&&sel.r==r&&sel.c==c)d.classList.add("sel");
    d.onclick=()=>clickCell(r,c);
    let p=board[r][c];
    if(p){
      let s=document.createElement("span");
      s.textContent=p.t;
      s.className="p"+p.o+(alive[p.o]?"":" dead");
      d.appendChild(s);
    }
    b.appendChild(d);
  }
  document.getElementById("turn").textContent="手番：プレイヤー"+(turn+1);
}

function undo(){
  if(!history.length)return;
  let h=JSON.parse(history.pop());
  board=h.board; hands=h.hands; alive=h.alive; turn=h.turn;
  draw();
}

init();
</script>
</body>
</html>
