<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>四人将棋 15×15 完成版</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --cell:40px; --gap:2px;
  --wood:#f4d9a6; --wood2:#e2b36d;
  --bg:#d9932a; --frame:#c6862c;
  --mark:#8fd3ff; --sel:#ff0;
}
body{margin:0;padding:10px;background:var(--bg);font-family:sans-serif}
h1{font-size:18px;margin:6px 0}

.topbar{margin-bottom:6px}
button{padding:6px 10px;border-radius:6px;border:1px solid #aaa;background:#fff7e0}

.layout{
  display:grid;
  grid-template-columns:220px auto 220px;
  grid-template-rows:auto auto;
  gap:10px;
  align-items:start;
}

.board{
  grid-column:2;
  grid-row:1 / span 2;
  display:grid;
  grid-template-columns:repeat(15,var(--cell));
  grid-template-rows:repeat(15,var(--cell));
  gap:var(--gap);
  background:var(--frame);
  padding:6px;
  border-radius:8px;
}

.cell{
  background:var(--wood);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;cursor:pointer;
}
.dark{background:var(--wood2)}
.wall{background:var(--bg);pointer-events:none}
.sel{outline:3px solid var(--sel)}
.move{background:var(--mark)!important}

.p0{transform:rotate(180deg)}
.p1{transform:rotate(270deg)}
.p2{transform:rotate(0deg)}
.p3{transform:rotate(90deg)}
.dead{opacity:.3}

.hand{
  background:#fff3d4;
  padding:6px;
  border-radius:6px;
}
.hand h3{font-size:13px;margin:0 0 6px;text-align:center}
.list{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.pc{
  background:#fff;padding:4px 6px;
  border-radius:4px;border:1px solid #999;
  cursor:pointer;
}
</style>
</head>
<body>

<h1>四人将棋 15×15（最終完成版）</h1>

<div class="topbar">
  <span id="turn"></span>
  <button onclick="undo()">待った</button>
  <button onclick="init()">初期化</button>
</div>

<div class="layout">
  <div class="hand" id="hand3"></div>
  <div class="hand" id="hand1"></div>

  <div class="board" id="board"></div>

  <div class="hand" id="hand0"></div>
  <div class="hand" id="hand2"></div>
</div>

<script>
/* ===== 基本 ===== */
const N=15,P=4;
const boardEl=document.getElementById('board');
const turnEl=document.getElementById('turn');
const handsEl=[
  document.getElementById('hand0'),
  document.getElementById('hand1'),
  document.getElementById('hand2'),
  document.getElementById('hand3')
];

let board,hands,alive,turn,sel=null,selHand=null,marks=[],history=[];

const back=['香','桂','銀','金','王','金','銀','桂','香'];
const promote={歩:'と',香:'杏',桂:'圭',銀:'全',角:'馬',飛:'龍'};
const unpromote={と:'歩',杏:'香',圭:'桂',全:'銀',馬:'角',龍:'飛'};

/* ===== 盤有効 ===== */
function inPlay(r,c){
  if(r<3&&c<3) return false;
  if(r<3&&c>=12) return false;
  if(r>=12&&c<3) return false;
  if(r>=12&&c>=12) return false;
  return r>=0&&r<N&&c>=0&&c<N;
}

/* ===== 向き ===== */
function dir(o){return[[1,0],[0,-1],[-1,0],[0,1]][o];}

/* ===== 向かい陣地 ===== */
function enemyZone(o,r,c){
  if(o===0) return r>=12;
  if(o===2) return r<=2;
  if(o===1) return c<=2;
  if(o===3) return c>=12;
}

/* ===== 初期化 ===== */
function init(){
  board=[...Array(N)].map(()=>Array(N).fill(null));
  hands=[[],[],[],[]];
  alive=[true,true,true,true];
  turn=0; sel=null; selHand=null; marks=[]; history=[];
  placeInitial(); draw();
}

/* ===== 初期配置 ===== */
function placeInitial(){
  const cols=[3,4,5,6,7,8,9,10,11];
  const rows=[3,4,5,6,7,8,9,10,11];

  for(let i=0;i<9;i++) board[0][cols[i]]={t:back[i],o:0};
  board[1][4]={t:'飛',o:0}; board[1][10]={t:'角',o:0};
  for(let i=0;i<9;i++) board[2][cols[i]]={t:'歩',o:0};

  for(let i=0;i<9;i++) board[rows[i]][14]={t:back[i],o:1};
  board[4][13]={t:'飛',o:1}; board[10][13]={t:'角',o:1};
  for(let i=0;i<9;i++) board[rows[i]][12]={t:'歩',o:1};

  for(let i=0;i<9;i++) board[14][cols[8-i]]={t:back[i],o:2};
  board[13][10]={t:'飛',o:2}; board[13][4]={t:'角',o:2};
  for(let i=0;i<9;i++) board[12][cols[8-i]]={t:'歩',o:2};

  for(let i=0;i<9;i++) board[rows[8-i]][0]={t:back[i],o:3};
  board[10][1]={t:'飛',o:3}; board[4][1]={t:'角',o:3};
  for(let i=0;i<9;i++) board[rows[8-i]][2]={t:'歩',o:3};
}

/* ===== 移動生成 ===== */
function genMoves(p,r,c){
  let res=[],d=dir(p.o);
  const add=(dr,dc,rep=false)=>{
    let nr=r+dr,nc=c+dc;
    while(inPlay(nr,nc)){
      if(board[nr][nc]&&board[nr][nc].o===p.o) break;
      res.push([nr,nc]);
      if(board[nr][nc]||!rep) break;
      nr+=dr; nc+=dc;
    }
  };
  const T=p.t;
  if(T==='歩') add(d[0],d[1]);
  else if(T==='香') add(d[0],d[1],true);
  else if(T==='桂') add(d[0]*2+d[1],d[1]*2-d[0]);
  else if(T==='銀')
    [[d[0],d[1]],[d[1],-d[0]],[-d[1],d[0]],
     [-d[0]+d[1],-d[1]-d[0]],[-d[0]-d[1],-d[1]+d[0]]]
     .forEach(x=>add(x[0],x[1]));
  else if(T==='金'||['と','杏','圭','全'].includes(T))
    [[d[0],d[1]],[d[1],-d[0]],[-d[1],d[0]],
     [d[0]-d[1],d[1]+d[0]],[-d[0]+d[1],-d[1]-d[0]]]
     .forEach(x=>add(x[0],x[1]));
  else if(T==='角'||T==='馬'){
    [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(x=>add(x[0],x[1],true));
    if(T==='馬') [[1,0],[-1,0],[0,1],[0,-1]].forEach(x=>add(x[0],x[1]));
  }
  else if(T==='飛'||T==='龍'){
    [[1,0],[-1,0],[0,1],[0,-1]].forEach(x=>add(x[0],x[1],true));
    if(T==='龍') [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(x=>add(x[0],x[1]));
  }
  else if(T==='王') for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++) if(dr||dc) add(dr,dc);
  return res;
}

/* ===== 王位置 ===== */
function kingPos(o){
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const p=board[r][c];
    if(p&&p.o===o&&p.t==='王') return [r,c];
  }
  return null;
}

/* ===== 王手判定 ===== */
function isCheck(o){
  const k=kingPos(o); if(!k) return false;
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const p=board[r][c];
    if(p&&p.o!==o&&alive[p.o]){
      if(genMoves(p,r,c).some(m=>m[0]===k[0]&&m[1]===k[1])) return true;
    }
  }
  return false;
}

/* ===== 合法手 ===== */
function legalMoves(r,c){
  const p=board[r][c];
  return genMoves(p,r,c).filter(([nr,nc])=>{
    const cap=board[nr][nc];
    board[nr][nc]=p; board[r][c]=null;
    const ok=!isCheck(p.o);
    board[r][c]=p; board[nr][nc]=cap;
    return ok;
  });
}

/* ===== 詰み ===== */
function isMate(o){
  if(!isCheck(o)) return false;
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const p=board[r][c];
    if(p&&p.o===o&&legalMoves(r,c).length) return false;
  }
  return true;
}

/* ===== 二歩 ===== */
function nifu(o,c){
  for(let r=0;r<N;r++){
    const p=board[r][c];
    if(p&&p.o===o&&p.t==='歩') return true;
  }
  return false;
}

/* ===== クリック（盤） ===== */
function clickCell(r,c){
  if(!inPlay(r,c)) return;

  if(sel && sel.r===r && sel.c===c){
    sel=null; marks=[]; draw(); return;
  }

  if(selHand){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      save();
      board[r][c]={t:selHand.t,o:turn};
      hands[turn].splice(selHand.i,1);
      selHand=null; marks=[];
      nextTurn(); draw();
    }
    return;
  }

  if(sel){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      save();
      const p=board[sel.r][sel.c];
      const cap=board[r][c];
      board[r][c]=p; board[sel.r][sel.c]=null;
      if(cap) hands[turn].push(unpromote[cap.t]||cap.t);

      if(promote[p.t] && enemyZone(p.o,r,c)){
        if(confirm('成りますか？')) p.t=promote[p.t];
      }

      const prev=turn;
      nextTurn();
      if(alive[turn] && isMate(turn)) alive[turn]=false;

      sel=null; marks=[]; draw();
    }
    return;
  }

  const p=board[r][c];
  if(p && p.o===turn && alive[p.o]){
    sel={r,c};
    marks=legalMoves(r,c);
    draw();
  }
}

/* ===== 持ち駒 ===== */
function clickHand(o,i){
  if(o!==turn||!alive[o]) return;
  sel=null;
  selHand={o,i,t:hands[o][i]};
  marks=[];
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    if(inPlay(r,c)&&!board[r][c]){
      if(selHand.t==='歩'&&nifu(o,c)) continue;
      board[r][c]={t:selHand.t,o};
      if(!isCheck(o)) marks.push([r,c]);
      board[r][c]=null;
    }
  }
  draw();
}

/* ===== 手番 ===== */
function nextTurn(){ do{turn=(turn+1)%4}while(!alive[turn]); }

/* ===== 履歴 ===== */
function save(){ history.push(JSON.stringify({board,hands,alive,turn})); }
function undo(){
  if(!history.length) return;
  const h=JSON.parse(history.pop());
  board=h.board; hands=h.hands; alive=h.alive; turn=h.turn;
  sel=null; selHand=null; marks=[]; draw();
}

/* ===== 描画 ===== */
function draw(){
  boardEl.innerHTML='';
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    const d=document.createElement('div');
    if(!inPlay(r,c)){d.className='cell wall';boardEl.appendChild(d);continue;}
    d.className='cell '+((r+c)%2?'dark':'');
    if(sel&&sel.r===r&&sel.c===c)d.classList.add('sel');
    if(marks.some(m=>m[0]===r&&m[1]===c))d.classList.add('move');
    if(board[r][c]){
      const s=document.createElement('span');
      s.textContent=board[r][c].t;
      s.className='p'+board[r][c].o+(alive[board[r][c].o]?'':' dead');
      d.appendChild(s);
    }
    d.onclick=()=>clickCell(r,c);
    boardEl.appendChild(d);
  }

  turnEl.textContent=`手番：P${turn+1}`;

  handsEl.forEach((el,o)=>{
    el.innerHTML=`<h3>P${o+1} 持ち駒</h3><div class="list"></div>`;
    const list=el.querySelector('.list');
    hands[o].forEach((pc,i)=>{
      const d=document.createElement('div');
      d.className='pc'; d.textContent=pc;
      d.onclick=()=>clickHand(o,i);
      list.appendChild(d);
    });
  });
}

init();
</script>
</body>
</html>
