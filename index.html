<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>四人将棋</title>
<style>
  body{font-family:sans-serif}
  table{border-collapse:collapse;margin:auto}
  td{
    width:36px;height:36px;
    border:1px solid #444;
    text-align:center;
    cursor:pointer;
    user-select:none;
  }
  .sel{background:#faa}
  .mark{background:#cfc}
  .dead{opacity:.3}
</style>
</head>
<body>

<h3 id="info"></h3>

<table id="board"></table>

<div id="hands"></div>

<script>
const N=15;
const players=4;
let turn=0;
let alive=[true,true,true,true];

let board=[...Array(N)].map(()=>Array(N).fill(null));
let hands=[[],[],[],[]];

let sel=null, marks=[];
let dropPiece=null;

/* ===== 初期配置（最低限） ===== */
board[7][7]={t:'王',o:0};
board[7][6]={t:'飛',o:0};
board[6][7]={t:'角',o:0};

board[0][7]={t:'王',o:1};
board[1][7]={t:'飛',o:1};
board[0][6]={t:'角',o:1};

board[7][14]={t:'王',o:2};
board[7][13]={t:'飛',o:2};
board[6][14]={t:'角',o:2};

board[14][7]={t:'王',o:3};
board[13][7]={t:'飛',o:3};
board[14][6]={t:'角',o:3};

const unpromote={};

/* ===== 描画 ===== */
function draw(){
  const t=document.getElementById('board');
  t.innerHTML='';
  for(let r=0;r<N;r++){
    const tr=document.createElement('tr');
    for(let c=0;c<N;c++){
      const td=document.createElement('td');
      let p=board[r][c];
      if(p){
        td.textContent=p.t;
        if(!alive[p.o]) td.classList.add('dead');
      }
      if(sel && sel.r===r && sel.c===c) td.classList.add('sel');
      if(marks.some(m=>m[0]===r&&m[1]===c)) td.classList.add('mark');
      td.onclick=()=>clickCell(r,c);
      tr.appendChild(td);
    }
    t.appendChild(tr);
  }
  drawHands();
  document.getElementById('info').textContent=
    `手番：P${turn+1} ${alive[turn]?'':'(脱落)'}`;
}

/* ===== 持ち駒 ===== */
function drawHands(){
  const d=document.getElementById('hands');
  d.innerHTML='';
  hands.forEach((h,i)=>{
    const div=document.createElement('div');
    div.textContent=`P${i+1}: `;
    if(!alive[i]) div.classList.add('dead');
    h.forEach((t,idx)=>{
      const b=document.createElement('button');
      b.textContent=t;
      b.disabled=!alive[turn]||turn!==i;
      b.onclick=()=>{
        dropPiece={t,from:i,idx};
        sel=null; marks=[];
      };
      div.appendChild(b);
    });
    d.appendChild(div);
  });
}

/* ===== 盤クリック ===== */
function clickCell(r,c){
  if(!alive[turn]) return;

  // 持ち駒を打つ
  if(dropPiece){
    if(board[r][c]) return;
    board[r][c]={t:dropPiece.t,o:turn};
    hands[turn].splice(dropPiece.idx,1);
    dropPiece=null;
    nextTurn(); draw(); return;
  }

  let p=board[r][c];
  if(sel){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      move(sel.r,sel.c,r,c);
    }
    sel=null; marks=[];
  }else if(p && p.o===turn){
    sel={r,c};
    marks=genMoves(p,r,c);
  }
  draw();
}

/* ===== 移動 ===== */
function move(sr,sc,r,c){
  let p=board[sr][sc];
  let cap=board[r][c];
  board[r][c]=p;
  board[sr][sc]=null;

  if(cap){
    if(cap.t==='王'){
      eliminate(cap.o);
    }else{
      hands[turn].push(cap.t);
    }
  }
  nextTurn();
}

/* ===== 脱落 ===== */
function eliminate(o){
  alive[o]=false;
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let p=board[r][c];
    if(p && p.o===o && p.t!=='王') board[r][c]=null;
  }
  hands[o]=[];
}

/* ===== 手番 ===== */
function nextTurn(){
  do{turn=(turn+1)%players}while(!alive[turn]);
}

/* ===== 駒の動き ===== */
function genMoves(p,r,c){
  let res=[];
  const slide=(dr,dc)=>{
    let nr=r+dr,nc=c+dc;
    while(nr>=0&&nr<N&&nc>=0&&nc<N){
      if(board[nr][nc]){
        if(board[nr][nc].t==='王'&&!alive[board[nr][nc].o]) break;
        if(board[nr][nc].o!==p.o) res.push([nr,nc]);
        break;
      }
      res.push([nr,nc]);
      nr+=dr; nc+=dc;
    }
  };
  if(p.t==='飛'){
    slide(1,0);slide(-1,0);slide(0,1);slide(0,-1);
  }
  if(p.t==='角'){
    slide(1,1);slide(1,-1);slide(-1,1);slide(-1,-1);
  }
  if(p.t==='王'){
    for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
      if(!dr&&!dc)continue;
      let nr=r+dr,nc=c+dc;
      if(nr<0||nr>=N||nc<0||nc>=N)continue;
      let q=board[nr][nc];
      if(!q||(q.o!==p.o&&!(q.t==='王'&&!alive[q.o])))
        res.push([nr,nc]);
    }
  }
  return res;
}

draw();
</script>
</body>
</html>
