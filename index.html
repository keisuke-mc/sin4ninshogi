<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>çœŸãƒ»å››äººå°†æ£‹</title>
<link rel="icon" href="favicon.ico?v=1">
<link rel="stylesheet" href="piece.css">
<link rel="stylesheet" href="hikari.css">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --cell:40px;
  --wood:#f4d9a6;
  --wood2:#e2b36d;
  --bg:#d9932a;
  --frame:#c6862c;
  --sel:#ff0;
  --move:#8fd3ff;
}
body{margin:0;padding:10px;background:var(--bg);font-family:sans-serif}
h1{margin:4px 0;font-size:18px}
button{padding:6px 10px;border-radius:6px;border:1px solid #888;background:#fff7e0}

.layout{
  display:grid;
  grid-template-columns:200px auto 200px;
  grid-template-rows:auto auto;
  gap:10px;
}
.board{
  grid-column:2;
  grid-row:1 / span 2;
  display:grid;
  grid-template-columns:repeat(15,var(--cell));
  grid-template-rows:repeat(15,var(--cell));
  gap:2px;
  background:var(--frame);
  padding:6px;
  border-radius:8px;
}
.cell{
  background:var(--wood);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
}
.dark{background:var(--wood2)}
.wall{background:var(--bg);pointer-events:none}
.sel{outline:3px solid var(--sel)}
.move{background:var(--move)!important}

.p0{transform:rotate(180deg)}
.p1{transform:rotate(270deg)}
.p2{transform:rotate(0deg)}
.p3{transform:rotate(90deg)}

.hand{
  background:#fff3d4;
  padding:6px;
  border-radius:6px;
}
.hand h3{margin:0 0 6px;font-size:13px;text-align:center}
.list{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
.pc{
  background:#fff;
  border:1px solid #999;
  border-radius:4px;
  padding:4px 6px;
  cursor:pointer;
}

/* ç‹æ‰‹è¡¨ç¤º */
#checkMsg{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:64px;
  font-weight:bold;
  color:red;
  text-shadow:3px 3px 6px #000;
  pointer-events:none;
  z-index:999;
}
</style>
</head>
<body>

<h1>çœŸãƒ»å››äººå°†æ£‹</h1>
<div>
  <span id="turn"></span>
  <button onclick="undo()">å¾…ã£ãŸ</button>
  <button onclick="init()">åˆæœŸåŒ–</button>
</div>

<div style="margin:6px 0">
  <label><input type="checkbox" id="mythToggle" checked onchange="mythMode=this.checked"> ç¥è©±æ©Ÿèƒ½</label>
  <label><input type="checkbox" id="vassalToggle" checked onchange="vassalMode=this.checked"> å®¶æ¥æ©Ÿèƒ½</label>
</div>

<div style="margin:6px 0">
  <button onclick="saveCode()">ã‚³ãƒ¼ãƒ‰ä¿å­˜</button>
  <button onclick="loadCode()">ã‚³ãƒ¼ãƒ‰å¾©å…ƒ</button>
</div>

<div class="layout">
  <div class="hand" id="hand0"></div>
  <div class="hand" id="hand1"></div>
  <div class="board" id="board"></div>
  <div class="hand" id="hand3"></div>
  <div class="hand" id="hand2"></div>
</div>

<div id="checkMsg">ç‹æ‰‹ï¼</div>

<script>
const N=15;
const boardEl=document.getElementById('board');
const turnEl=document.getElementById('turn');
const handsEl=[hand0,hand1,hand2,hand3];
const checkMsg=document.getElementById('checkMsg');

let board,hands,alive,turn;
let mythMode = true;   // ç¥è©±æ©Ÿèƒ½ï¼ˆç‹â†’ç¥ï¼‰
let vassalMode = true; // å®¶æ¥æ©Ÿèƒ½ï¼ˆç‹ã‚’å–ã‚‹ã¨å®¶ï¼‰

/* ç¥ã®åˆ¤å®š */
function isGod(p){
  return p.t === 'ç¥';
}

function isAngel(p){
  return p.t === 'å¤©';
}

let sel=null, selHand=null, marks=[];
let history=[];

const back=['é¦™','æ¡‚','éŠ€','é‡‘','ç‹','é‡‘','éŠ€','æ¡‚','é¦™'];
const promoteMap={æ­©:'ã¨',é¦™:'æ',æ¡‚:'åœ­',éŠ€:'å…¨',è§’:'é¦¬',é£›:'é¾'};
const unpromote={ã¨:'æ­©',æ:'é¦™',åœ­:'æ¡‚',å…¨:'éŠ€',é¦¬:'è§’',é¾:'é£›'};

function save(){
  history.push(JSON.stringify({board,hands,alive,turn}));
}
function undo(){
  if(!history.length) return;
  let s=JSON.parse(history.pop());
  board=s.board; hands=s.hands; alive=s.alive; turn=s.turn;
  sel=null; selHand=null; marks=[];
  draw();
}

function inPlay(r,c){
  if(r<3&&c<3) return false;
  if(r<3&&c>=12) return false;
  if(r>=12&&c<3) return false;
  if(r>=12&&c>=12) return false;
  return r>=0&&r<N&&c>=0&&c<N;
}
function dir(o){return[[1,0],[0,-1],[-1,0],[0,1]][o];}

function initCore(){
  board=[...Array(N)].map(()=>Array(N).fill(null));
  hands=[[],[],[],[]];
  alive=[true,true,true,true];
  turn=0;
  history=[];
  placeInitial();
  draw();
}

function init(){
  if(!confirm('åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nä»Šã®å¯¾å±€ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ã€‚')){
    return;
  }
  initCore();
}

function placeInitial(){
  const cols=[3,4,5,6,7,8,9,10,11];
  const rows=[3,4,5,6,7,8,9,10,11];
  for(let i=0;i<9;i++) board[0][cols[i]]={t:back[i],o:0};
  board[1][4]={t:'é£›',o:0}; board[1][10]={t:'è§’',o:0};
  for(let i=0;i<9;i++) board[2][cols[i]]={t:'æ­©',o:0};

  for(let i=0;i<9;i++) board[rows[i]][14]={t:back[i],o:1};
  board[4][13]={t:'é£›',o:1}; board[10][13]={t:'è§’',o:1};
  for(let i=0;i<9;i++) board[rows[i]][12]={t:'æ­©',o:1};

  for(let i=0;i<9;i++) board[14][cols[8-i]]={t:back[i],o:2};
  board[13][10]={t:'é£›',o:2}; board[13][4]={t:'è§’',o:2};
  for(let i=0;i<9;i++) board[12][cols[8-i]]={t:'æ­©',o:2};

  for(let i=0;i<9;i++) board[rows[8-i]][0]={t:back[i],o:3};
  board[10][1]={t:'é£›',o:3}; board[4][1]={t:'è§’',o:3};
  for(let i=0;i<9;i++) board[rows[8-i]][2]={t:'æ­©',o:3};
}

function inEnemyCamp(o,r,c){
  return (o===0&&r>=12)||(o===2&&r<=2)||(o===1&&c<=2)||(o===3&&c>=12);
}

/* ===== é§’ã®å‹•ã ===== */
function genMoves(p,r,c){
  let res=[];
  let F=dir(p.o), B=[-F[0],-F[1]], L=[F[1],-F[0]], R=[-F[1],F[0]];
  const add=(dr,dc,rep=false)=>{
    let nr=r+dr,nc=c+dc;
    while(inPlay(nr,nc)){
      if(board[nr][nc]&&board[nr][nc].o===p.o) break;
      res.push([nr,nc]);
      if(board[nr][nc]||!rep) break;
      nr+=dr; nc+=dc;
    }
  };

  if(p.t==='æ­©') add(...F);
  if(p.t==='é¦™') add(...F,true);

  if(p.t==='æ¡‚'){
    add(F[0]*2+L[0],F[1]*2+L[1]);
    add(F[0]*2+R[0],F[1]*2+R[1]);
  }

  if(p.t==='éŠ€'){
    [F,[F[0]+L[0],F[1]+L[1]],[F[0]+R[0],F[1]+R[1]],
     [B[0]+L[0],B[1]+L[1]],[B[0]+R[0],B[1]+R[1]]]
     .forEach(v=>add(v[0],v[1]));
  }

  if('é‡‘ã¨æåœ­å…¨'.includes(p.t)){
    [F,L,R,B,[F[0]+L[0],F[1]+L[1]],[F[0]+R[0],F[1]+R[1]]]
    .forEach(v=>add(v[0],v[1]));
  }

  if(p.t==='ç‹'||p.t==='å®¶'){
    [
      F,B,L,R,
      [F[0]+L[0],F[1]+L[1]],
      [F[0]+R[0],F[1]+R[1]],
      [B[0]+L[0],B[1]+L[1]],
      [B[0]+R[0],B[1]+R[1]]
    ].forEach(v=>add(v[0],v[1]));
  }

  /* ç¥ï¼šç‹ + ã‚¯ã‚¤ãƒ¼ãƒ³ */
  if(p.t==='ç¥'){
    // å…¨æ–¹å‘1ãƒã‚¹
    [
      F,B,L,R,
      [F[0]+L[0],F[1]+L[1]],
      [F[0]+R[0],F[1]+R[1]],
      [B[0]+L[0],B[1]+L[1]],
      [B[0]+R[0],B[1]+R[1]]
    ].forEach(v=>add(v[0],v[1]));

    // ç¸¦æ¨ªç„¡é™
    [F,B,L,R].forEach(v=>add(v[0],v[1],true));

    // æ–œã‚ç„¡é™
    [
      [F[0]+L[0],F[1]+L[1]],
      [F[0]+R[0],F[1]+R[1]],
      [B[0]+L[0],B[1]+L[1]],
      [B[0]+R[0],B[1]+R[1]]
    ].forEach(v=>add(v[0],v[1],true));
  }

  /* å¤©ï¼šã‚¯ã‚¤ãƒ¼ãƒ³ã®ã¿ */
  if(p.t==='å¤©'){
    // ç¸¦æ¨ªç„¡é™
    [F,B,L,R].forEach(v=>add(v[0],v[1],true));

    // æ–œã‚ç„¡é™
    [
      [F[0]+L[0],F[1]+L[1]],
      [F[0]+R[0],F[1]+R[1]],
      [B[0]+L[0],B[1]+L[1]],
      [B[0]+R[0],B[1]+R[1]]
    ].forEach(v=>add(v[0],v[1],true));
  }

  if(p.t==='é£›'||p.t==='é¾') [F,B,L,R].forEach(v=>add(v[0],v[1],true));

  if(p.t==='è§’'||p.t==='é¦¬')
    [[F[0]+L[0],F[1]+L[1]],[F[0]+R[0],F[1]+R[1]],
     [B[0]+L[0],B[1]+L[1]],[B[0]+R[0],B[1]+R[1]]]
    .forEach(v=>add(v[0],v[1],true));

  if(p.t==='é¾'){
    [[F[0]+L[0],F[1]+L[1]],
     [F[0]+R[0],F[1]+R[1]],
     [B[0]+L[0],B[1]+L[1]],
     [B[0]+R[0],B[1]+R[1]]]
    .forEach(v=>add(v[0],v[1]));
  }

  if(p.t==='é¦¬'){
    [F,B,L,R].forEach(v=>add(v[0],v[1]));
  }

  return res;
}

/* ===== ç‹æ‰‹åˆ¤å®šï¼ˆæ”»æ’ƒå´é™å®šï¼‰ ===== */
function isCheck(attacker){
  for(let o=0;o<4;o++){
    if(o===attacker||!alive[o]) continue;
    let kr,kc;
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      let p=board[r][c];
      if(p&&p.o===o&&p.t==='ç‹'){kr=r;kc=c;}
    }
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      let p=board[r][c];
      if(p&&p.o===attacker){
        if(genMoves(p,r,c).some(m=>m[0]===kr&&m[1]===kc))
          return true;
      }
    }
  }
  return false;
}

function showCheck(){
  checkMsg.style.display='flex';
  setTimeout(()=>checkMsg.style.display='none',800);
}

function clickCell(r,c){
  if(!inPlay(r,c)) return;

  if(selHand){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      save();
      board[r][c]={t:selHand.t,o:turn,dropped:true};
      hands[turn].splice(selHand.i,1);
      selHand=null; marks=[];
      if(isCheck(turn)) showCheck();
      nextTurn(); draw();
    }
    return;
  }

  if(sel){
    if(marks.some(m=>m[0]===r&&m[1]===c)){
      save();
      let p=board[sel.r][sel.c];
      let cap=board[r][c];
      board[r][c]=p; board[sel.r][sel.c]=null;

      /* ç‹â†’ç¥ */
      if(mythMode && p.t==='ç‹' && inEnemyCamp(p.o,r,c)){
        if(confirm('ç¥ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ')){
          p.t='ç¥';
        }
      }

      /* å®¶â†’å¤© */
      if(mythMode && p.t==='å®¶' && inEnemyCamp(p.o,r,c)){
        if(confirm('å¤©ä½¿ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ')){
          p.t='å¤©';
        }
      }

      /* â˜… å®¶ãŒæ•µé™£ã§å¤©ã«ãªã‚‹ */
      if(mythMode && p.t==='å®¶' && inEnemyCamp(p.o,r,c)){
        p.t='å¤©';
      }    
      
      /* â˜… æˆã‚Šåˆ¤å®šï¼ˆå…ˆï¼ï¼‰ */
      if(
        promoteMap[p.t] &&
        inEnemyCamp(p.o,r,c) &&
        p.dropped
      ){
        if(confirm('æˆã‚‹ï¼Ÿ')) p.t = promoteMap[p.t];
      }

      /* â˜… æ¬¡ã« dropped ã‚’æ¶ˆã™ */
      if(p.dropped){
        delete p.dropped;
      }
      
      if(cap){
        // ç¥ã‚’å–ã‚‰ã‚ŒãŸã‚‰è„±è½
        if(cap.t==='ç¥'){
          alive[cap.o]=false;
          checkWin();
       
          
          // å®¶æ¥æ©Ÿèƒ½ONãªã‚‰å®¶ã‚‚ã‚‚ã‚‰ãˆã‚‹
          if(vassalMode){
            hands[turn].push('å®¶');
          }
        } 
        // ç‹ã‚’å–ã£ãŸã‚‰
        else if(cap.t==='ç‹'){
          // ç‹ã¯å¿…ãšè„±è½
          alive[cap.o]=false;
          checkWin();

          // å®¶æ¥æ©Ÿèƒ½ONãªã‚‰å®¶ã‚‚ã‚‚ã‚‰ãˆã‚‹
          if(vassalMode){
            hands[turn].push('å®¶');
          }
        }
        else{
          hands[turn].push(unpromote[cap.t]||cap.t);
        }
      }

      if(
        promoteMap[p.t] &&
        inEnemyCamp(p.o,r,c) &&
        (!p.dropped || p.movedAfterDrop)
      ){
        if(confirm('æˆã‚‹ï¼Ÿ')) p.t = promoteMap[p.t];
      }

      sel=null; marks=[];
      if(isCheck(turn)) showCheck();
      nextTurn(); draw();
    }else{ sel=null; marks=[]; draw(); }
    return;
  }

  let p=board[r][c];
  if(p && p.o===turn){
    sel={r,c}; marks=genMoves(p,r,c); draw();
  }
}

function clickHand(o,i){
  if(o!==turn) return;

  /* ã‚‚ã†ä¸€å›æŠ¼ã—ãŸã‚‰è§£é™¤ */
  if(selHand && selHand.o===o && selHand.i===i){
    selHand=null; marks=[]; draw(); return;
  }

  let t=hands[o][i];
  selHand={o,i,t}; marks=[];
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    if(!inPlay(r,c)||board[r][c]) continue;
    if(t==='æ­©'){
      let ok=true;
      for(let k=0;k<N;k++){
        let rr=o%2===0?k:r, cc=o%2===0?c:k;
        let p=board[rr][cc];
        if(p&&p.o===o&&p.t==='æ­©') ok=false;
      }
      if(!ok) continue;
    }
    marks.push([r,c]);
  }
  draw();
}

function nextTurn(){
  do{ turn=(turn+1)%4 }while(!alive[turn]);
}

function checkWin(){
  let a=alive.filter(v=>v);
  if(a.length===1){
    alert(`ğŸ‰ P${alive.indexOf(true)+1} ã®å‹ã¡ï¼`);
  }
}

function draw(){
  boardEl.innerHTML='';
  for(let r=0;r<N;r++)for(let c=0;c<N;c++){
    let d=document.createElement('div');
    if(!inPlay(r,c)){ d.className='cell wall'; boardEl.appendChild(d); continue; }
    d.className='cell '+((r+c)%2?'dark':'');
    if(sel&&sel.r===r&&sel.c===c) d.classList.add('sel');
    if(marks.some(m=>m[0]===r&&m[1]===c)) d.classList.add('move');
    if(board[r][c]){
      let s = document.createElement('div');
      s.dataset.piece = board[r][c].t;
      s.className = 'piece p' + board[r][c].o;
      d.appendChild(s);
    }
    d.onclick=()=>clickCell(r,c);
    boardEl.appendChild(d);
  }
  turnEl.textContent='æ‰‹ç•ªï¼šP'+(turn+1);
  handsEl.forEach((el,o)=>{
    el.innerHTML=alive[o]?`<h3>P${o+1} æŒã¡é§’</h3><div class=list></div>`:`<h3>P${o+1} è„±è½</h3>`;
    if(!alive[o]) return;
    let list=el.querySelector('.list');
    hands[o].forEach((pc,i)=>{
      let d=document.createElement('div');
      d.className='pc'; d.textContent=pc;
      d.onclick=()=>clickHand(o,i);
      list.appendChild(d);
    });
  });

  boardEl.className = 'board turn' + turn;
}

/*ä¿å­˜æ©Ÿèƒ½*/
function exportCode(){
  const data = {
    board,
    hands,
    alive,
    turn,
    mythMode,
    vassalMode
  };
  return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
}

/*å¾©å…ƒæ©Ÿèƒ½*/
function importCode(code){
  try{
    const data = JSON.parse(
      decodeURIComponent(escape(atob(code)))
    );

    board = data.board;
    hands = data.hands;
    alive = data.alive;
    turn  = data.turn;

    mythMode = data.mythMode ?? true;
    vassalMode = data.vassalMode ?? true;

    document.getElementById('mythToggle').checked = mythMode;
    document.getElementById('vassalToggle').checked = vassalMode;
    
    sel = null;
    selHand = null;
    marks = [];
    history = [];

    draw();
  }catch(e){
    alert('ã‚³ãƒ¼ãƒ‰ãŒå£Šã‚Œã¦ã‚‹ã§');
  }
}


/*å¾©å…ƒãƒœã‚¿ãƒ³ç”¨*/
function saveCode(){
  const code = exportCode();

  if(navigator.clipboard){
    navigator.clipboard.writeText(code)
      .then(()=>{
        alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
      })
      .catch(()=>{
        fallbackCopy(code);
      });
  }else{
    fallbackCopy(code);
  }
}

function fallbackCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  alert('ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function loadCode(){
  const code = prompt('ä¿å­˜ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ã¦ãã ã•ã„ã€‚');
  if(code) importCode(code.trim());
}

initCore();
</script>
</body>
</html>
