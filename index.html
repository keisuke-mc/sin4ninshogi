<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>四人将棋 完全版（修正版）</title>
<style>
body {
  display: flex;
  justify-content: center;
  align-items: center;
  background:#eee;
  font-family: sans-serif;
}
#container {
  display: grid;
  grid-template-columns: 200px 1fr 200px;
  gap: 10px;
}
.hand {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.board {
  display: grid;
  grid-template-columns: repeat(15, 40px);
  grid-template-rows: repeat(15, 40px);
  background: #d8b36a;
}
.cell {
  border: 1px solid #555;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 18px;
  cursor: pointer;
}
.disabled {
  background: #555;
  cursor: default;
}
.highlight {
  background: rgba(0,255,0,0.4);
}
.piece {
  font-weight: bold;
}
.P1 { color: black; }
.P2 { color: blue; }
.P3 { color: red; }
.P4 { color: green; }
</style>
</head>
<body>

<div id="container">
  <div class="hand" id="handLeft"></div>
  <div class="board" id="board"></div>
  <div class="hand" id="handRight"></div>
</div>

<script>
/* =====================
   基本定義
===================== */

const SIZE = 15;
const DISABLED_ZONE = (r,c) =>
  (r<3&&c<3)||(r<3&&c>11)||(r>11&&c<3)||(r>11&&c>11);

const players = ["P1","P2","P3","P4"];
let currentPlayer = 0;

const direction = {
  P1:{dx:0,dy:1},
  P2:{dx:-1,dy:0},
  P3:{dx:0,dy:-1},
  P4:{dx:1,dy:0}
};

const board = [];
const hands = {P1:[],P2:[],P3:[],P4:[]};

let selected = null;
let highlights = [];

/* =====================
   駒の動き（基準：P1）
===================== */

const moves = {
  王:[[1,0],[0,1],[-1,0],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]],
  金:[[0,1],[1,0],[-1,0],[0,-1],[1,1],[-1,1]],
  銀:[[0,1],[1,1],[-1,1],[1,-1],[-1,-1]],
  歩:[[0,1]],
  香:[[0,1,"line"]],
  桂:[[1,2],[-1,2]],
  角:[[1,1,"line"],[-1,1,"line"],[1,-1,"line"],[-1,-1,"line"]],
  飛:[[1,0,"line"],[-1,0,"line"],[0,1,"line"],[0,-1,"line"]],
};

/* 成り */
const promoteMap = {
  歩:"金",香:"金",桂:"金",銀:"金",
  角:"馬",飛:"龍"
};

function rotate(dx,dy,player){
  if(player==="P1") return [dx,dy];
  if(player==="P2") return [dy,-dx];
  if(player==="P3") return [-dx,-dy];
  if(player==="P4") return [-dy,dx];
}

/* =====================
   盤生成
===================== */

const boardDiv = document.getElementById("board");

for(let y=0;y<SIZE;y++){
  board[y]=[];
  for(let x=0;x<SIZE;x++){
    const cell=document.createElement("div");
    cell.className="cell";
    if(DISABLED_ZONE(y,x)) cell.classList.add("disabled");
    cell.dataset.x=x;
    cell.dataset.y=y;
    cell.onclick=()=>onCellClick(x,y);
    boardDiv.appendChild(cell);
    board[y][x]=null;
  }
}

/* =====================
   初期配置（香あり）
===================== */

function place(x,y,type,owner){
  board[y][x]={type,owner,promoted:false};
  render();
}

place(7,1,"王","P1");
place(13,7,"王","P2");
place(7,13,"王","P3");
place(1,7,"王","P4");

/* 香 */
place(7,2,"香","P1");
place(12,7,"香","P2");
place(7,12,"香","P3");
place(2,7,"香","P4");

/* =====================
   合法手計算
===================== */

function legalMoves(x,y){
  const p=board[y][x];
  if(!p) return [];
  let list=[];
  let base=p.promoted? (p.type==="馬"? "角":p.type==="龍"?"飛":"金"):p.type;
  let mlist=moves[base];
  if(!mlist) return [];
  for(const m of mlist){
    const [rx,ry]=rotate(m[0],m[1],p.owner);
    if(m[2]==="line"){
      let nx=x+rx, ny=y+ry;
      while(nx>=0&&ny>=0&&nx<SIZE&&ny<SIZE&&!DISABLED_ZONE(ny,nx)){
        if(board[ny][nx]){
          if(board[ny][nx].owner!==p.owner) list.push([nx,ny]);
          break;
        }
        list.push([nx,ny]);
        nx+=rx; ny+=ry;
      }
    }else{
      const nx=x+rx, ny=y+ry;
      if(nx>=0&&ny>=0&&nx<SIZE&&ny<SIZE&&!DISABLED_ZONE(ny,nx)){
        if(!board[ny][nx]||board[ny][nx].owner!==p.owner)
          list.push([nx,ny]);
      }
    }
  }
  return list;
}

/* =====================
   UI操作
===================== */

function clearHighlight(){
  document.querySelectorAll(".highlight").forEach(c=>c.classList.remove("highlight"));
  highlights=[];
}

function onCellClick(x,y){
  if(DISABLED_ZONE(y,x)) return;
  if(selected && highlights.some(h=>h[0]===x&&h[1]===y)){
    movePiece(selected.x,selected.y,x,y);
    selected=null;
    clearHighlight();
    nextTurn();
    return;
  }
  if(board[y][x] && board[y][x].owner===players[currentPlayer]){
    if(selected && selected.x===x&&selected.y===y){
      selected=null;
      clearHighlight();
      return;
    }
    selected={x,y};
    clearHighlight();
    const ms=legalMoves(x,y);
    for(const [mx,my] of ms){
      const idx=my*SIZE+mx;
      boardDiv.children[idx].classList.add("highlight");
      highlights.push([mx,my]);
    }
  }
}

/* =====================
   移動・成り
===================== */

function movePiece(sx,sy,tx,ty){
  const p=board[sy][sx];
  if(board[ty][tx]){
    const taken=board[ty][tx];
    taken.promoted=false;
    hands[p.owner].push(taken.type);
  }
  board[ty][tx]=p;
  board[sy][sx]=null;

  if(promoteMap[p.type]){
    if(confirm("成りますか？")){
      p.type=promoteMap[p.type];
      p.promoted=true;
    }
  }
  render();
}

function nextTurn(){
  currentPlayer=(currentPlayer+1)%4;
}

/* =====================
   描画
===================== */

function render(){
  boardDiv.querySelectorAll(".cell").forEach(c=>c.textContent="");
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    const p=board[y][x];
    if(p){
      const idx=y*SIZE+x;
      const cell=boardDiv.children[idx];
      cell.textContent=p.type;
      cell.classList.add("piece",p.owner);
    }
  }
}

render();
</script>
</body>
</html>
